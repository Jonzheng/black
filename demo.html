<html>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<header>
    <script src="./js/jquery-3.3.1.min.js" type="text/javascript"></script>
    <script src="./js/bootstrap.min.js" type="text/javascript"></script>
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/main.css" rel="stylesheet">
    <script>
        $(function(){
            window.AudioContext = window.AudioContext||window.webkitAudioContext;
            const context = new AudioContext();
            const url = 'https://06mdkod2.qcloud.la/weapp/uAudio'
            const urls = 'https://418980938.omoz.club/weapp/uAudio'
            const pre = "https://audio-1256378396.cos.ap-guangzhou.myqcloud.com/"
            var key_size = {}
            var file_ids = new Array();
            //console.log(auCtx)
            $("#btn-all").on("click", function(){
                $.ajax({
                    url: url,
                    type: "post",
                    crossDomain: true,
                    success: function(data){
                        var t_audio = data.data.t_list
                        var content = data.data.content
                        //initMap(content)
                        initMapAudio(t_audio)
                        initTableContent(content)
                    }
                });
            })

            var loadDogSound = function(url){
                var request = new XMLHttpRequest();
                request.open('GET', url, true);
                //request.setRequestHeader('Accept','text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8')
                //request.setRequestHeader('Content-Type','audio/mp3')
                request.responseType= 'arraybuffer';
                
                //下面就是对音频文件的异步解析
                request.onload = function(){
                        context.decodeAudioData(request.response,function(buffer){
                            console.log(buffer)
                            playSound(buffer)
                    },function(err){
                        console.log(err)
                    })
                }

                request.send()
            }

            var playSound = function (buffer){
                var source = context.createBufferSource();
                source.buffer = buffer;//  告诉音频源 播放哪一段音频
                source.connect(context.destination);// 连接到输出源
                source.start();//开始播放
            }

            var initMapAudio = function(t_audio){
                console.log("initMapAudio")
                //console.log(t_audio)
                for (let val of t_audio){
                    var file_id = val.file_id
                    file_ids.push(file_id)
                }
            }

            var initMap = function(content){
                console.log("init_map")
                //console.log(content)
                for (let val of content){
                    var Key = val.Key
                    var kk = Key.substr(0, Key.indexOf("."))
                    key_size[kk] = parseInt(val.Size)
                }
            }

            var initTableContent = function(content){
                console.log("init_content")
                $("#t_content > tbody tr").remove()
                //console.log(file_ids)
                //console.log(t_audio)
                //t_audio.sort((a,b) => {return a.c_name > b.c_name})
                //console.log(t_audio)
                //console.log(key_size)
                for (let [i,v] of content.entries()){
                    //console.log(v)
                    var line = i+1
                    var file_id = v.Key.substr(0, v.Key.indexOf("."))
                    if (file_ids.includes(file_id)) continue
                    var src = pre + v.Key
                    var ks = file_id.split("_")
                    var level = ks[0]
                    var file_id = file_id
                    var s_name = ks[1]
                    var ski = ks[2]
                    var ver = ks[3]
                    var size = v.Size
                    var u_date = v.LastModified
                    var d_td = `<tr><td>${line}</td><td>${level}</td><td class="src_play pointer" id="${src}">${file_id}</td><td class="pointer">${s_name}</td><td>${ski}</td><td>${ver}</td><td>${size}</td><td>${u_date}</td></tr>`
                    $("#t_content > tbody").append(d_td)
                }

                //table函数绑定
                $("#t_content .src_play").click(function(){
                    console.log("src_click")
                    var src_audio = $(this).attr("id")
                    console.log(src_audio)
                    loadDogSound(src_audio)
                })
            }

            var initTable = function(t_audio){
                console.log("init_table")
                //console.log(t_audio)
                //t_audio.sort((a,b) => {return a.c_name > b.c_name})
                //console.log(t_audio)
                //console.log(key_size)
                for (let [i,v] of t_audio.entries()){
                    //console.log(v)
                    var line = i+1
                    var file_id = v.file_id
                    var c_name = v.c_name
                    var s_name = v.s_name
                    var src = v.src_audio
                    var c_date = v.c_date
                    var cate = v.cate
                    var level = v.level
                    var ski = v.ski
                    var ver = v.ver
                    var status = v.status
                    var d_td = `<tr><td>${line}</td><td>${level}</td><td>${file_id}</td><td>${c_name}</td><td>${ski}</td><td>${ver}</td><td>${s_name}</td><td>${cate}</td><td>${c_date}</td><td>${status}</td></tr>`
                    $("tbody").append(d_td)
                }
            }
        })


    </script>

</header>

<body>
    <hr>
    <div class="btn-group" data-toggle="buttons">
        <label class="btn btn-default active">
            <input type="radio" name="options" autocomplete="off" checked>全部
        </label>
        <label id='btn-all' class="btn btn-default">
            <input type="radio" name="options" autocomplete="off">SSR
        </label>
        <label class="btn btn-default">
            <input type="radio" name="options" autocomplete="off">SR
        </label>
        <label class="btn btn-default">
            <input type="radio" name="options" autocomplete="off">R
        </label>
        <label class="btn btn-default">
            <input type="radio" name="options" autocomplete="off">N
        </label>
        <label class="btn btn-default">
            <input type="radio" name="options" autocomplete="off">呱呱
        </label>
    </div>
    <hr>
    <div class="">
        <table id="t_audio" class="table table-bordered table-striped table-hover hidden">
            <thead>
                <tr>
                    <th>#</th>
                    <th>level</th>
                    <th>file_id</th>
                    <th>c_name</th>
                    <th>ski</th>
                    <th>ver</th>
                    <th>s_name</th>
                    <th>cate</th>
                    <th>c_date</th>
                    <th>status</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <table id="t_content" class="table table-bordered table-striped table-hover">
            <thead>
                <tr>
                    <th>#</th>
                    <th>level</th>
                    <th>file_id</th>
                    <th>s_name</th>
                    <th>ski</th>
                    <th>ver</th>
                    <th>size</th>
                    <th>u_date</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

</body>

</html>