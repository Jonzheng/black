<html>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<header>
    <script src="./js/jquery-3.3.1.min.js" type="text/javascript"></script>
    <script src="./js/bootstrap.min.js" type="text/javascript"></script>
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/main.css" rel="stylesheet">
    <script>
        $(function(){
            window.AudioContext = window.AudioContext||window.webkitAudioContext;
            const context = new AudioContext();
            const url = 'https://06mdkod2.qcloud.la/weapp/queryAudio'
            const publishUrl = 'https://06mdkod2.qcloud.la/weapp/publishAudio'
            const urls = 'https://418980938.omoz.club/weapp/queryAudio'
            const publishUrls = 'https://418980938.omoz.club/weapp/publishAudio'
            const pre = "https://audio-1256378396.cos.ap-guangzhou.myqcloud.com/"
            var key_size = {}
            var file_ids = new Array();
            $("table").hide()
            $("#btn-all").on("click", function(){
                $.ajax({
                    url: url,
                    type: "post",
                    crossDomain: true,
                    success: function(data){
                        var t_audio = data.data.t_list
                        var content = data.data.content
                        //initMap(content)
                        initMapAudio(t_audio)
                        initTableContent(content)
                    }
                });
            })

            var loadSound = function(url,code){
                var request = new XMLHttpRequest();
                request.open('GET', url, true);
                //request.setRequestHeader('Accept','text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8')
                //request.setRequestHeader('Content-Type','audio/mp3')
                request.responseType= 'arraybuffer';
                
                //下面就是对音频文件的异步解析
                request.onload = function(){
                        context.decodeAudioData(request.response,function(buffer){
                            if(code == 1){
                                playSound(buffer)
                            }else{
                                listenSound(buffer)
                            }
                            
                    },function(err){
                        console.log(err)
                    })
                }

                request.send()
            }
            var formatShadow = function(_shadow){
                var shadow = []
                //使数据过渡更顺滑
                for (let i = 0; i < _shadow.length; i++) {
                    if (_shadow[i] < _shadow[i + 1] / 2){
                        _shadow[i] = _shadow[i + 1] / 2;
                    }
                    if (_shadow[i] / 2 > _shadow[i + 1]){
                        _shadow[i + 1] = _shadow[i] / 2;
                    }
                }
                //每9个数据取平均值
                var _max = 0
                for (let i = 0; i < _shadow.length; i++) {
                    if (i % 9 == 0){
                        let av = (_shadow[i] + _shadow[i + 1] + _shadow[i + 2] + _shadow[i + 3]+ _shadow[i + 4]+ _shadow[i + 5]+ _shadow[i + 6]+ _shadow[i + 7]+ _shadow[i + 8]) / 9
                        let sam = Math.round(av)
                        shadow.push(sam)
                        if (sam > _max) _max = sam
                    }
                }
                //使数据过渡更顺滑--取整
                for (let i = 0; i < shadow.length; i++) {
                    if (shadow[i] < shadow[i + 1] / 2) {
                        shadow[i] = Math.round(shadow[i + 1] / 2);
                    }
                    if (shadow[i] / 2 > shadow[i + 1]) {
                        shadow[i + 1] = Math.round(shadow[i] / 2);
                    }
                }
                //变换数据--最大值100
                var rate = 100 / _max
                for (let i = 0; i < shadow.length; i++) {
                    if (shadow[i] > 3){
                        shadow[i] = Math.round(shadow[i] * rate)
                    }
                    if (shadow[i] < 3){
                        shadow[i] = 3
                    }
                    if (shadow[i] == 4){
                        shadow[i] = 5
                    }
                }
                //填充到100个元素
                shadow.pop()
                var fn = 100-shadow.length
                if (fn > 0){
                    var fill_st = new Array(fn)
                    fill_st.fill(3)
                    shadow = shadow.concat(fill_st)
                }
                return shadow
            }

            var initBoxShadow = function(shadow){
                console.log("initBoxShadow")
                var s_shadow = shadow + ""
                $("#s-shadow").val(s_shadow)
                //$("#btn-save").data("s_shadow", s_shadow)
                $("#box-shadow > span").remove()
                for (let v of shadow){
                    var d_sd = `<span class="ele" style="height:${v}px"></span>`
                    $("#box-shadow").append(d_sd)
                }
            }

            var getShadow = function(analyser, dataArray, duration){
                var _shadow = []
                var intv = 10
                console.log(duration)
                var dura = 0
                var inter_id = setInterval(function () {
                    analyser.getByteTimeDomainData(dataArray);
                    var sum = 0
                    for(let v of dataArray){
                        sum += v
                    }
                    var h = Math.abs(8192 - sum) / 10
                    if (h < 3) h = 3
                    _shadow.push(h)
                    dura += intv
                    if (dura > duration){
                        //console.log(_shadow)
                        var shadow = formatShadow(_shadow)
                        console.log(shadow)
                        initBoxShadow(shadow)
                        clearInterval(inter_id)
                    }
                }, intv);
            }

            var listenSound = function (buffer){
                console.log("listenSound:")
                var source = context.createBufferSource();
                source.buffer = buffer;
                source.connect(context.destination);
                source.start();
            }

            var playSound = function (buffer){
                var source = context.createBufferSource();
                var analyser = context.createAnalyser();
                source.buffer = buffer;
                source.connect(analyser);
                analyser.connect(context.destination);
                analyser.fftSize = 128;
                var bufferLength = analyser.frequencyBinCount;
                var dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);
                source.start();
                analyser.getByteTimeDomainData(dataArray);
                var duration = buffer.duration*1000
                getShadow(analyser, dataArray, duration)
            }

            var initMapAudio = function(t_audio){
                console.log("initMapAudio")
                //console.log(t_audio)
                for (let val of t_audio){
                    var file_id = val.file_id
                    file_ids.push(file_id)
                }
            }

            var initMap = function(content){
                console.log("init_map")
                //console.log(content)
                for (let val of content){
                    var Key = val.Key
                    var kk = Key.substr(0, Key.indexOf("."))
                    key_size[kk] = parseInt(val.Size)
                }
            }

            $("#s-title,#s-serifu,#s-roma").on("keyup",function(){
                var _val = $(this).val().trim()
                $(this).val(_val)
                var cur_id = $(this).attr("id")
                var p_id = "#p" + cur_id.substr(1)
                //console.log(cur_id, p_id)
                $(p_id).text(_val)
            })

            $("#btn-save").on("click",function(){
                console.log("save")
                var $title = $("#s-title")
                if (!$title.val()){
                    $title.focus()
                    return
                }
                var formData = new FormData($("#my-form")[0]);
                $.ajax({
                    type: "post",
                    crossDomain: true,
                    url: publishUrl,
                    data: formData,
                    cache: false,
                    processData: false,
                    contentType: false,
                    success: function(data){
                        console.log(data)
                        $("#modal-to").modal("hide")
                    }
                })
            })

            var initModal = function(file_id, src_audio){
                $("#m-title").text(file_id)
                $("#src-audio").text(src_audio)
                $("#s-file_id").val(file_id)
                $("#s-title").val("")
                $("#s-serifu").val("")
                $("#s-roma").val("")
            }

            var initTableContent = function(content){
                console.log("init_content")
                $("table").hide()
                $("#t_content").show()
                $("#t_content > tbody tr").remove()
                //t_audio.sort((a,b) => {return a.c_name > b.c_name})
                for (let [i,v] of content.entries()){
                    var line = i+1
                    var file_id = v.Key.substr(0, v.Key.indexOf("."))
                    if (file_ids.includes(file_id)) continue
                    var src = pre + v.Key
                    var ks = file_id.split("_")
                    var level = ks[0]
                    var file_id = file_id
                    var s_name = ks[1]
                    var ski = ks[2]
                    var ver = ks[3]
                    var size = v.Size
                    var u_date = v.LastModified
                    var d_td = `<tr><td>${line}</td><td>${level}</td><td class="src-play pointer" id="${src}">${file_id}</td><td class="prepare pointer" data-file_id="${file_id}" data-src="${src}">${s_name}</td><td>${ski}</td><td>${ver}</td><td>${size}</td><td>${u_date}</td></tr>`
                    $("#t_content > tbody").append(d_td)
                }

                //table函数绑定
                $("#t_content .src-play").click(function(){
                    console.log("src_click")
                    var src_audio = $(this).attr("id")
                    loadSound(src_audio, 0)
                })

                $("#t_content .prepare").click(function(){
                    console.log("prepare_click")
                    var src_audio = $(this).data("src")
                    var file_id = $(this).data("file_id")
                    initModal(file_id, src_audio)
                    initBoxShadow([])
                    $("#modal-to").modal("show")
                })
            }

            var initTableQuestion = function(t_question){
                $("table").hide()
                $("#t_question").show()
                $("#t_question > tbody tr").remove()
                console.log(t_question)
                for (let [i,v] of t_question.entries()){
                    var line = i+1
                    var level = v.level
                    var title = v.title
                    var difficulty = v.difficulty
                    var uploader = v.uploader
                    var c_date = v.c_date
                    var d_td = `<tr><td>${line}</td><td>${level}</td><td class="pointer prepare">${title}</td><td>${difficulty}</td><td>${uploader}</td><td>${c_date}</td></tr>`
                    $("#t_question > tbody").append(d_td)
                }

                $("#t_question .prepare").click(function(){
                    console.log("prepare_click")
                    $("#modal-question").modal("show")
                })

                $(".pointer").on("mouseover",function(){
                    $(this).addClass("bg-info")
                })
                $(".pointer").on("mouseout",function(){
                    $(this).removeClass("bg-info")
                })
            }

            var initTable = function(t_audio){
                console.log("init_table")
                //t_audio.sort((a,b) => {return a.c_name > b.c_name})
                for (let [i,v] of t_audio.entries()){
                    var line = i+1
                    var file_id = v.file_id
                    var c_name = v.c_name
                    var s_name = v.s_name
                    var src = v.src_audio
                    var c_date = v.c_date
                    var cate = v.cate
                    var level = v.level
                    var ski = v.ski
                    var ver = v.ver
                    var status = v.status
                    var d_td = `<tr><td>${line}</td><td>${level}</td><td>${file_id}</td><td>${c_name}</td><td>${ski}</td><td>${ver}</td><td>${s_name}</td><td>${cate}</td><td>${c_date}</td><td>${status}</td></tr>`
                    $("#t_audio > tbody").append(d_td)
                }
            }

            //点击事件
            $("#btn-question").on("click",function(){
                console.log("btn-question")
                var t_question = [{"level":"N4","title":"新手测试1","difficulty":"0.9","uploader":"Jono","c_date":"2018-07-08"}]
                initTableQuestion(t_question)
            })

            $("#file").on("change",function(){
                var $img = $(this).next("img")
                var $file = $(this);
                var fileObj = $file[0];
                var windowURL = window.URL || window.webkitURL;
                var dataURL;

                if (fileObj && fileObj.files && fileObj.files[0]) {
                    dataURL = windowURL.createObjectURL(fileObj.files[0]);
                    $img.attr('src', dataURL);
                } else {
                    dataURL = $file.val();
                    var imgObj = document.getElementById("preview");
                    imgObj.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)";
                    imgObj.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = dataURL;
    
                }


            })

            $("#btn-play").on("click",function(){
                var src_audio = $("#src-audio").text()
                console.log(src_audio)
                loadSound(src_audio, 1)
            })
        })


    </script>

</header>

<body>

    <div id="modal-to" class="modal fade bs-example-modal-lg" aria-hidden="true" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="to_list">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="m-title">file_id</h4>
                        </div>

                        <div class="modal-body">
                            <form id="my-form" class="form-horizontal" enctype="multipart/form-data">
                                <input id="s-shadow" name="shadow" type="hidden">
                                <input id="s-file_id" name="file_id" type="hidden">
                                <div class="box-content">
                                    <input id="file" name="file" class="up-image pointer" type="file">
                                    <img class="box-img" src="">
                                    <div class="box-text">
                                        <p id="src-audio" class="hidden"></p>
                                        <strong><p id="p-title" class="text-primary"></p></strong>
                                        <p id="p-serifu" class="text-primary"></p>
                                        <p id="p-roma" class="text-primary"></p>
                                    </div>
                                </div>
                                    <div id="box-shadow" class="box-shadow">
                                        <div id="btn-play" class="box-img pointer"></div>
                                    </div>
                                    <hr>
                                <div class="form-group">
                                    <label class="text-primary col-sm-2 control-label">式神名字:</label>
                                    <div class="col-sm-9">
                                        <input id="s-c_name" name="c_name" type="text" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="text-primary col-sm-2 control-label">标题:</label>
                                    <div class="col-sm-9">
                                        <input id="s-title" name="title" type="text" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="text-primary col-sm-2 control-label">台词:</label>
                                    <div class="col-sm-9">
                                    <input id="s-serifu" name="serifu" type="text" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="text-primary col-sm-2 control-label">罗马音:</label>
                                    <div class="col-sm-9">
                                        <input id="s-roma" name="roma" type="text" class="form-control">
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button id="btn-save" type="button" class="btn btn-primary">保存</button>
                    </div>
            </div>
        </div>
    </div>
<!-- modal end -->

<div id="modal-question" class="modal fade bs-example-modal-lg" aria-hidden="true" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="to_list">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">编辑试题</h4>
                </div>

                    <div class="modal-body">
                        <form id="form-que-title" class="form-horizontal" enctype="multipart/form-data">
                            <div class="box-content">
                                <div class="box-question-title">
                                    <div class="form-group">
                                        <label class="text-primary col-sm-2 control-label">标题:</label>
                                        <div class="col-sm-9">
                                            <input id="" name="" type="text" class="form-control">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="text-primary col-sm-2 control-label">备注:</label>
                                        <div class="col-sm-4">
                                            <input id="" name="" type="text" class="form-control">
                                        </div>

                                        <select class="form-control col-sm-3 go-level">
                                                <option>--等级难度--</option>
                                                <option>N2</option>
                                                <option>N3</option>
                                                <option>N4</option>
                                                <option>N5</option>
                                        </select>

                                        <div class="btn-group" data-toggle="buttons">
                                            <label class="btn btn-default">
                                                <input type="radio" name="options" id="op-easy" autocomplete="off">容易
                                            </label>
                                            <label class="btn btn-default active">
                                                <input type="radio" name="options" id="op-normal" autocomplete="off" checked>正常
                                            </label>
                                            <label class="btn btn-default">
                                                <input type="radio" name="options" id="op-diff" autocomplete="off">困难
                                            </label>
                                        </div>

                                    </div>
                                    
                                </div>
                            </div>
                        </form>
                        <hr>
    <div class="btn-group" data-toggle="buttons">
        <label class="btn btn-default">
            <input type="radio" name="options" id="option1" autocomplete="off">试卷预览
        </label>
        <label class="btn btn-default active">
            <input type="radio" name="options" id="option2" autocomplete="off" checked>选择题
        </label>
        <label class="btn btn-default">
            <input type="radio" name="options" id="option3" autocomplete="off">阅读题
        </label>
        <label class="btn btn-default">
            <input type="radio" name="options" id="option4" autocomplete="off">听解题(I)
        </label>
        <label class="btn btn-default">
            <input type="radio" name="options" id="option4" autocomplete="off">听解题(II)
        </label>
    </div>
            <hr>
            <div class="box-question">
                <form id="form-que-1" class="form-horizontal" enctype="multipart/form-data">

                    <div class="form-group">
                        <label class="text-primary col-sm-2 control-label">阅读材料:</label>
                        <div class="col-sm-9">
                            <textarea class="form-control" rows="9"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="text-primary col-sm-2 control-label">听力材料:</label>
                        <div class="col-sm-4">
                            <input id="" name="" type="text" class="form-control" readonly>
                        </div>
                        <button type="button" class="btn btn-default col-sm-2">上传</button>
                        <button type="button" class="btn btn-default col-sm-2">试听</button>
                    </div>
                    <hr>
                    <div class="form-group">
                        <label class="text-primary col-sm-2 control-label">编号:</label>
                        <div class="col-sm-9">
                            <input id="" name="" type="text" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="text-primary col-sm-2 control-label">题目:</label>
                        <div class="col-sm-9">
                            <textarea class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="text-primary col-sm-2 control-label">选项A:</label>
                        <div class="col-sm-6">
                            <input id="" name="" type="text" class="form-control">
                        </div>
                        <button type="button" class="btn btn-default col-sm-2">正解</button>
                    </div>
                    <div class="form-group">
                        <label class="text-primary col-sm-2 control-label">选项B:</label>
                        <div class="col-sm-6">
                            <input id="" name="" type="text" class="form-control">
                        </div>
                        <button type="button" class="btn btn-default col-sm-2">正解</button>
                    </div>
                    <div class="form-group">
                        <label class="text-primary col-sm-2 control-label">选项C:</label>
                        <div class="col-sm-6">
                            <input id="" name="" type="text" class="form-control">
                        </div>
                        <button type="button" class="btn btn-default col-sm-2">正解</button>
                    </div>
                    <div class="form-group">
                        <label class="text-primary col-sm-2 control-label">选项D:</label>
                        <div class="col-sm-6">
                            <input id="" name="" type="text" class="form-control">
                        </div>
                        <button type="button" class="btn btn-default col-sm-2">正解</button>
                    </div>
                    <hr>
                    <div class="form-group">
                        <label class="text-primary col-sm-2 control-label">正解:</label>
                        <div class="col-sm-9">
                            <input id="" name="" type="text" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="text-primary col-sm-2 control-label">解析:</label>
                        <div class="col-sm-9">
                            <textarea class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div><!-- box-question end -->
        </div><!-- modal-body end -->

                <div class="box-question">
                    <button type="button" class="btn btn-info">下一题</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button id="btn-save" type="button" class="btn btn-primary">保存</button>
                </div>
        </div>
    </div>
</div>
<!-- modal end -->

    <hr>
    <div class="btn-group" data-toggle="buttons">
        <label class="btn btn-default active">
            <input type="radio" name="options" autocomplete="off" checked>全部
        </label>
        <label id='btn-all' class="btn btn-default">
            <input type="radio" name="options" autocomplete="off">待发布
        </label>
        <label id="btn-question" class="btn btn-default">
            <input type="radio" name="options" autocomplete="off">呱呱
        </label>
    </div>
    <hr>
    <div class="">
        <table id="t_audio" class="table table-bordered table-striped table-hover">
            <thead>
                <tr>
                    <th>#</th>
                    <th>level</th>
                    <th>file_id</th>
                    <th>c_name</th>
                    <th>ski</th>
                    <th>ver</th>
                    <th>s_name</th>
                    <th>cate</th>
                    <th>c_date</th>
                    <th>status</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <table id="t_content" class="table table-bordered table-striped table-hover">
            <thead>
                <tr>
                    <th>#</th>
                    <th>level</th>
                    <th>file_id</th>
                    <th>s_name</th>
                    <th>ski</th>
                    <th>ver</th>
                    <th>size</th>
                    <th>u_date</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <table id="t_question" class="table table-bordered table-striped table-hover">
            <thead>
                <tr>
                    <th>#</th>
                    <th>日语等级</th>
                    <th>标题</th>
                    <th>难度</th>
                    <th>创建者</th>
                    <th>创建时间</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

</body>

</html>