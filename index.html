<html>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<header>
    <script src="./js/jquery-3.3.1.min.js" type="text/javascript"></script>
    <script src="./js/bootstrap.min.js" type="text/javascript"></script>
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/main.css" rel="stylesheet">
    <script>
        $(function(){
            window.AudioContext = window.AudioContext||window.webkitAudioContext;
            const context = new AudioContext();
            const url = 'https://06mdkod2.qcloud.la/weapp/queryAudio'
            const publishUrl = 'https://06mdkod2.qcloud.la/weapp/publishAudio'
            const urls = 'https://418980938.omoz.club/weapp/queryAudio'
            const publishUrls = 'https://418980938.omoz.club/weapp/publishAudio'
            const pre = "https://audio-1256378396.cos.ap-guangzhou.myqcloud.com/"

            const save_paper = 'https://06mdkod2.qcloud.la/weapp/savePaper'
            const save_question = 'https://06mdkod2.qcloud.la/weapp/saveQuestion'
            const query_paper = 'https://06mdkod2.qcloud.la/weapp/queryPaper'
            const query_question = 'https://06mdkod2.qcloud.la/weapp/queryQuestion'
            const black_login = 'https://06mdkod2.qcloud.la/weapp/blackLogin'

            var key_size = {}
            var file_ids = new Array();
            var __auth_name = ""
            var __openid = "ocVQY4-dF2m4IiYTTJZFo6k-NZbE"
            if(__openid == ""){
                $("#top-menu").hide()
            }else{
                $("#top-login").hide()
                $("#top-menu").show(233)
            }

            $("#auth-btn").on("click", function(){
                var $auth_name =  $("#auth-name")
                var $auth_code =  $("#auth-code")
                var auth_name =$auth_name.val().trim()
                var auth_code = $auth_code.val().trim()
                if(auth_name == ""){
                    $auth_name.focus()
                    return
                }
                if(auth_code == ""){
                    $auth_code.focus()
                    return
                }
                $.ajax({
                    type: "post",
                    crossDomain: true,
                    url: black_login,
                    data: {auth_name, auth_code},
                    success: function(data){
                        var user_lst = data.data
                        if (user_lst.length == 1){
                            user = user_lst[0]
                            console.log(user)
                            __auth_name = user.auth_name
                            __openid = user.openid
                            $auth_code.attr("placeholder","密码")
                            $("#top-login").hide()
                            $("#top-menu").show(233)
                        }else{
                            $auth_code.val("")
                            $auth_code.focus()
                            $auth_code.attr("placeholder","密码 / 用户名错误")
                        }
                    }
                })
            })

            $("#btn-prepare").on("click", function(){
                $.ajax({
                    url: url,
                    type: "post",
                    crossDomain: true,
                    success: function(data){
                        var t_audio = data.data.t_list
                        var content = data.data.content
                        //initMap(content)
                        initMapAudio(t_audio)
                        initTableContent(content)
                    }
                });
            })

            var loadSound = function(url,code){
                var request = new XMLHttpRequest();
                request.open('GET', url, true);
                //request.setRequestHeader('Accept','text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8')
                //request.setRequestHeader('Content-Type','audio/mp3')
                request.responseType= 'arraybuffer';
                
                //下面就是对音频文件的异步解析
                request.onload = function(){
                        context.decodeAudioData(request.response,function(buffer){
                            if(code == 1){
                                playSound(buffer)
                            }else{
                                listenSound(buffer)
                            }
                            
                    },function(err){
                        console.log(err)
                    })
                }

                request.send()
            }
            var formatShadow = function(_shadow){
                var shadow = []
                //使数据过渡更顺滑
                for (let i = 0; i < _shadow.length; i++) {
                    if (_shadow[i] < _shadow[i + 1] / 2){
                        _shadow[i] = _shadow[i + 1] / 2;
                    }
                    if (_shadow[i] / 2 > _shadow[i + 1]){
                        _shadow[i + 1] = _shadow[i] / 2;
                    }
                }
                //每9个数据取平均值
                var _max = 0
                for (let i = 0; i < _shadow.length; i++) {
                    if (i % 9 == 0){
                        let av = (_shadow[i] + _shadow[i + 1] + _shadow[i + 2] + _shadow[i + 3]+ _shadow[i + 4]+ _shadow[i + 5]+ _shadow[i + 6]+ _shadow[i + 7]+ _shadow[i + 8]) / 9
                        let sam = Math.round(av)
                        shadow.push(sam)
                        if (sam > _max) _max = sam
                    }
                }
                //使数据过渡更顺滑--取整
                for (let i = 0; i < shadow.length; i++) {
                    if (shadow[i] < shadow[i + 1] / 2) {
                        shadow[i] = Math.round(shadow[i + 1] / 2);
                    }
                    if (shadow[i] / 2 > shadow[i + 1]) {
                        shadow[i + 1] = Math.round(shadow[i] / 2);
                    }
                }
                //变换数据--最大值100
                var rate = 100 / _max
                for (let i = 0; i < shadow.length; i++) {
                    if (shadow[i] > 3){
                        shadow[i] = Math.round(shadow[i] * rate)
                    }
                    if (shadow[i] < 3){
                        shadow[i] = 3
                    }
                    if (shadow[i] == 4){
                        shadow[i] = 5
                    }
                }
                //填充到100个元素
                shadow.pop()
                var fn = 100-shadow.length
                if (fn > 0){
                    var fill_st = new Array(fn)
                    fill_st.fill(3)
                    shadow = shadow.concat(fill_st)
                }
                return shadow
            }

            var initBoxShadow = function(shadow){
                console.log("initBoxShadow")
                var s_shadow = shadow + ""
                $("#s-shadow").val(s_shadow)
                //$("#btn-save").data("s_shadow", s_shadow)
                $("#box-shadow > span").remove()
                for (let v of shadow){
                    var d_sd = `<span class="ele" style="height:${v}px"></span>`
                    $("#box-shadow").append(d_sd)
                }
            }

            var getShadow = function(analyser, dataArray, duration){
                var _shadow = []
                var intv = 10
                console.log(duration)
                var dura = 0
                var inter_id = setInterval(function () {
                    analyser.getByteTimeDomainData(dataArray);
                    var sum = 0
                    for(let v of dataArray){
                        sum += v
                    }
                    var h = Math.abs(8192 - sum) / 10
                    if (h < 3) h = 3
                    _shadow.push(h)
                    dura += intv
                    if (dura > duration){
                        //console.log(_shadow)
                        var shadow = formatShadow(_shadow)
                        console.log(shadow)
                        initBoxShadow(shadow)
                        clearInterval(inter_id)
                    }
                }, intv);
            }

            var listenSound = function (buffer){
                console.log("listenSound:")
                var source = context.createBufferSource();
                source.buffer = buffer;
                source.connect(context.destination);
                source.start();
            }

            var playSound = function (buffer){
                var source = context.createBufferSource();
                var analyser = context.createAnalyser();
                source.buffer = buffer;
                source.connect(analyser);
                analyser.connect(context.destination);
                analyser.fftSize = 128;
                var bufferLength = analyser.frequencyBinCount;
                var dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);
                source.start();
                analyser.getByteTimeDomainData(dataArray);
                var duration = buffer.duration*1000
                getShadow(analyser, dataArray, duration)
            }

            var initMapAudio = function(t_audio){
                console.log("initMapAudio")
                //console.log(t_audio)
                for (let val of t_audio){
                    var file_id = val.file_id
                    file_ids.push(file_id)
                }
            }

            var initMap = function(content){
                console.log("init_map")
                //console.log(content)
                for (let val of content){
                    var Key = val.Key
                    var kk = Key.substr(0, Key.indexOf("."))
                    key_size[kk] = parseInt(val.Size)
                }
            }

            $("#file_audio").on("change",function(){
                var $img = $(this).next("img")
                var $file_audio = $(this);
                var fileObj = $file_audio[0];
                var windowURL = window.URL || window.webkitURL;
                var dataURL;

                if (fileObj && fileObj.files && fileObj.files[0]) {
                    dataURL = windowURL.createObjectURL(fileObj.files[0]);
                    $img.attr('src', dataURL);
                } else {
                    console.log("file_audio else...")
                }
            })

            $("#s-title,#s-serifu,#s-roma").on("keyup",function(){
                var _val = $(this).val().trim()
                $(this).val(_val)
                var cur_id = $(this).attr("id")
                var p_id = "#p" + cur_id.substr(1)
                //console.log(cur_id, p_id)
                $(p_id).text(_val)
            })

            $("#btn-save").on("click",function(){
                console.log("save")
                var $title = $("#s-title")
                if (!$title.val()){
                    $title.focus()
                    return
                }
                var formData = new FormData($("#my-form")[0]);
                $.ajax({
                    type: "post",
                    crossDomain: true,
                    url: publishUrl,
                    data: formData,
                    cache: false,
                    processData: false,
                    contentType: false,
                    success: function(data){
                        console.log(data)
                        $("#modal-to").modal("hide")
                    }
                })
            })

            var initModal = function(file_id, src_audio){
                $("#m-title").text(file_id)
                $("#src-audio").text(src_audio)
                $("#s-file_id").val(file_id)
                $("#s-title").val("")
                $("#s-serifu").val("")
                $("#s-roma").val("")
            }

            var initTableContent = function(content){
                console.log("init_content")
                $("table").hide()
                $("#t_content").show()
                $("#t_content > tbody tr").remove()
                //t_audio.sort((a,b) => {return a.c_name > b.c_name})
                for (let [i,v] of content.entries()){
                    var line = i+1
                    var file_id = v.Key.substr(0, v.Key.indexOf("."))
                    if (file_ids.includes(file_id)) continue
                    var src = pre + v.Key
                    var ks = file_id.split("_")
                    var level = ks[0]
                    var file_id = file_id
                    var s_name = ks[1]
                    var ski = ks[2]
                    var ver = ks[3]
                    var size = v.Size
                    var u_date = v.LastModified
                    var d_td = `<tr><td>${line}</td><td>${level}</td><td class="src-play pointer" id="${src}">${file_id}</td><td class="prepare pointer" data-file_id="${file_id}" data-src="${src}">${s_name}</td><td>${ski}</td><td>${ver}</td><td>${size}</td><td>${u_date}</td></tr>`
                    $("#t_content > tbody").append(d_td)
                }

                //table函数绑定
                $("#t_content .src-play").click(function(){
                    console.log("src_click")
                    var src_audio = $(this).attr("id")
                    loadSound(src_audio, 0)
                })

                $("#t_content .prepare").click(function(){
                    console.log("prepare_click")
                    var src_audio = $(this).data("src")
                    var file_id = $(this).data("file_id")
                    initModal(file_id, src_audio)
                    initBoxShadow([])
                    $("#modal-to").modal("show")
                })
            }

            var initTablePaper = function(t_paper){
                $("table").hide()
                $("#t_paper").show()
                $("#t_paper > tbody tr").remove()
                console.log(t_paper)
                var map_paper = {}
                for (let [i,v] of t_paper.entries()){
                    var line = i+1
                    var paper_id = v.paper_id
                    map_paper[paper_id] = v
                    var title = v.title
                    var description = v.description
                    var total = v.total
                    var level = v.level
                    var difficulty = v.difficulty
                    var uploader = "somebody"
                    var _prepare = ""
                    if (v.uploader == __openid){
                        uploader = __auth_name
                        _prepare = "prepare"
                    }
                    var c_date = v.c_date.substr(0,10)
                    var d_td = `<tr class="pointer ${_prepare}" data-paper_id=${paper_id}><td>${line}</td><td>${title}</td><td>${description}</td><td>${total}</td><td>${level}</td><td>${difficulty}</td><td>${uploader}</td><td>${c_date}</td></tr>`
                    $("#t_paper > tbody").append(d_td)
                }

                $("#t_paper > tbody > .prepare").click(function(){
                    console.log("tr__prepare_click")
                    var paper_id = $(this).closest("tr").data("paper_id")
                    var paper = map_paper[paper_id]
                    initModalPaper(paper)
                })

                $(".prepare").on("mouseover",function(){
                    $(this).addClass("bg-info")
                })
                $(".prepare").on("mouseout",function(){
                    $(this).removeClass("bg-info")
                })
            }

            $("#paper-add").click(function(){
                console.log("paper__add")
                initModalPaper([])
            })

            var initModalPaper = function(paper){
                console.log(paper)
                $('#paper-level > option[selected]').removeAttr("selected")
                if (paper.paper_id != undefined){
                    $("#paper-title").data("paper_id", paper.paper_id)
                    $("#paper-title").val(paper.title)
                    $("#paper-description").val(paper.description)
                    $("#paper-attention").val(paper.attention)
                    var tar_level = '#paper-level > option[value="'+paper.level+'"]'
                    $(tar_level).attr("selected", true)
                    var tar_diff = "#paper-"+paper.difficulty
                    $(tar_diff).trigger("click")
                    //查询试题
                    loadQuestion(paper.paper_id)
                    $("#paper-bar").css("width", "100%")
                    $("#paper-menu").show(233)
                }else{
                    var paper_id = new Date().getTime()
                    $("#paper-title").data("paper_id", paper_id)
                    $("#paper-title").val("")
                    $("#paper-description").val("")
                    $("#paper-attention").val("")
                    $("#level-default").attr("selected", true)
                    $("#paper-normal").trigger("click")
                    $("#paper-bar").css("width", "0%")
                    $("#paper-menu").hide()
                }
                $("#modal-paper").modal("show")
            }

            var initTable = function(t_audio){
                console.log("init_table")
                //t_audio.sort((a,b) => {return a.c_name > b.c_name})
                for (let [i,v] of t_audio.entries()){
                    var line = i+1
                    var file_id = v.file_id
                    var c_name = v.c_name
                    var s_name = v.s_name
                    var src = v.src_audio
                    var c_date = v.c_date
                    var cate = v.cate
                    var level = v.level
                    var ski = v.ski
                    var ver = v.ver
                    var status = v.status
                    var d_td = `<tr><td>${line}</td><td>${level}</td><td>${file_id}</td><td>${c_name}</td><td>${ski}</td><td>${ver}</td><td>${s_name}</td><td>${cate}</td><td>${c_date}</td><td>${status}</td></tr>`
                    $("#t_audio > tbody").append(d_td)
                }
            }

            //查询试卷
            $("#btn-paper").on("click",function(){
                console.log("btn-paper")
                $.ajax({
                    type: "post",
                    crossDomain: true,
                    url: query_paper,
                    success: function(data){
                        var t_paper = data.data
                        initTablePaper(t_paper)
                    }
                })
            })

            //试题分类型预览
            var initPreviewQuestion = function(t_question){
                console.log("initPreviewQuestion...")
                for (let v of t_question){
                    var $template = $("#template-que").clone(true)

                    //填充数据
                    $template.data("question", v)
                    //填充预览页
                    var right_option_class = ".right_option_" + v.right_option.toLowerCase()
                    $template.find(right_option_class).addClass("active")
                    $template.find(".preview-question_no").text(v.question_no)
                    $template.find(".preview-title").text(v.title)
                    if (v.title_image){
                        $template.find(".preview-title_image").attr("src", v.title_image)
                        $template.find(".preview-title_image").show()

                        $template.find(".img-title_image").attr("src", v.title_image)
                        $template.find(".que-title_image").val(v.title_image)
                    }
                    $template.find(".preview-option_a").text(v.option_a)
                    $template.find(".preview-option_b").text(v.option_b)
                    $template.find(".preview-option_c").text(v.option_c)
                    $template.find(".preview-option_d").text(v.option_d)

                    //填充可编辑页
                    $template.find(".que-title").val(v.title)
                    $template.find(".que-option_a").val(v.option_a)
                    $template.find(".que-option_b").val(v.option_b)
                    $template.find(".que-option_c").val(v.option_c)
                    $template.find(".que-option_d").val(v.option_d)

                    //隐藏input
                    $template.find(".que-type").val(v.type)
                    $template.find(".que-paper_id").val(v.paper_id)
                    $template.find(".que-question_no").val(v.question_no)
                    
                    if (v.type > 10 && v.type <= 20 && v.question_no ==1){
                        if (v.article){
                            $template.find(".que-article").val(v.article)
                            $template.find(".preview-article").val(v.article)
                            $template.find(".box-preview-article").show()
                        }else if (v.src_image){
                            $template.find(".que-src_image").val(v.src_image)
                            $template.find(".preview-src_image").attr("src", v.src_image)
                            $template.find(".preview-src_image").show()
                        }
                    }else if(v.type > 20 && v.question_no ==1){
                        if(v.src_sound){
                            $template.find(".preview-src_sound").attr("src", v.src_sound)
                            $template.find(".preview-src_sound").show()
                        }
                    }
                    $template.find(".que-src_image").val(v.src_image)

                    $template.find(".que-right_option").val(v.right_option)
                    $template.find(".que-an_explain").val(v.an_explain)

                    var que_type_class = "type_" + v.type
                    $template.addClass(que_type_class)
                    
                    //去除id并放到容器
                    $template.removeAttr("id")
                    $template.insertBefore($("#que-add"))
                }
            }

            //查询试题:paper_id
            var loadQuestion = function(paper_id){
                console.log("loadQuestion...")
                $.ajax({
                    type: "post",
                    crossDomain: true,
                    url: query_question,
                    data: {paper_id},
                    success: function(data){
                        var t_question = data.data
                        initPreviewQuestion(t_question)
                    },
                    error: function(data){
                        console.log(data)
                    }
                })
            }

            $(".box-template,.box-question-title").on("mouseover",function(){
                $(this).find(".glyphicon").show()
            })
            $(".box-template,.box-question-title").on("mouseout",function(){
                $(this).find(".glyphicon").hide()
            })

            $(".src-que").on("click",function(){
                var $template = $(this).closest(".box-template")
                var box_class = "." + $(this).data("box")
                if ($(this).hasClass("active")){ //to_hide
                    $(this).find("span").text("添加图片")

                    $template.find(".que-title_image").val("")
                    $template.find(".preview-title_image").hide()
                    $template.find(".preview-title_image").attr("src", "")
                    $template.find(".img-title_image").attr("src", "")

                    $template.find(".file_title_image")[0].value = ""

                    var $src_box =  $template.find(box_class)
                    $src_box.hide()
                }else{
                    $(this).find("span").text("删除图片")
                    $template.find(box_class).show(233)
                }
                
            })

            $(".up-que-sound").on("change",function(){
                var $show_input = $(this).next("input")
                var fileObj = $(this)[0]
                console.log(fileObj.files)
                if (fileObj && fileObj.files && fileObj.files[0]) {
                    //选择了文件
                    var file_name = fileObj.files[0].name
                    console.log("file selected:",file_name)
                    $show_input.val(file_name)
                } else {
                    //没有选择文件
                    console.log("file not ...")
    
                }
            })

            $(".file_title_image,.file_src_image").on("change",function(){
                var $img = $(this).next("img")
                var fileObj = $(this)[0]
                var windowURL = window.URL || window.webkitURL
                var dataURL
                console.log(fileObj.files)
                if (fileObj && fileObj.files && fileObj.files[0]) {
                    //选择了文件
                    console.log("file selected ...")
                    dataURL = windowURL.createObjectURL(fileObj.files[0])
                    $img.attr('src', dataURL)

                    var $template = $(this).closest(".box-template")
                    if ( $(this).hasClass("file_title_image") ) $template.find(".que-title_image").val("")
                    if ( $(this).hasClass("file_src_image") ) $template.find(".que-src_image").val("")
                } else {
                    //没有选择文件
                    console.log("file not ...")
    
                }
            })

            $(".que-edit").on("click",function(){
                $(this).css("opacity",0)
                var $template = $(this).closest(".box-template")
                //var question = $template.data("question")
                var que_type = $template.find(".que-type").val().trim()
                var que_no = $template.find(".que-question_no").val().trim()
                var article = $template.find(".que-article").val().trim()
                var right_option = $template.find(".que-right_option").val().trim()
                var title_image = $template.find(".preview-title_image").attr("src")

                if(title_image != "") {
                    console.log(title_image)
                    $template.find("label.title_image > span").text("删除图片")
                    $template.find("label.title_image").addClass("active")
                    $template.find(".box-title-image").show()

                    $template.find(".file_title_image")[0].value = ""
                }else{
                    $template.find("label.title_image > span").text("添加图片")
                    $template.find("label.title_image").removeClass("active")
                    $template.find(".box-title-image").hide()
                }

                if (que_type > 10 && que_type <= 20 && que_no == 1){
                    $template.find(".btn-type-read").show()
                    if (article) $template.find(".label-article").trigger("click")
                }else if (que_type > 20 && que_no == 1){
                    $template.find(".box-type-sound").show()
                }

                var right_option_class = ".right_option_" + right_option.toLowerCase()
                $template.find(right_option_class).addClass("active")
                $template.find(".label-question_no").text(que_no)
                
                $template.find(".que-preview").hide(666)
                $template.find(".que-preview-edit").show(666)
                $template.find(".que-save").css("opacity",1)
                var edit = $("#box-question").data("edit")
                edit = edit + 1
                $("#box-question").data("edit", edit)
                $("#que-add").hide()
            })
            
            //保存成功--试题预览
            var showQuePreview = function($template){
                var type = $template.find(".que-type").val().trim()
                var que_type_class = "type_" + type
                $template.addClass(que_type_class)
                var que_no = $template.find(".que-question_no").val().trim()
                $("#que-add").data("que_no", que_no)

                var article = $template.find(".que-article").val().trim()
                var title = $template.find(".que-title").val().trim()
                var option_a = $template.find(".que-option_a").val().trim()
                var option_b = $template.find(".que-option_b").val().trim()
                var option_c = $template.find(".que-option_c").val().trim()
                var option_d = $template.find(".que-option_d").val().trim()

                $template.find(".preview-question_no").text(que_no)
                $template.find(".preview-article").val(article)
                $template.find(".preview-title").text(title)
                $template.find(".preview-option_a").text(option_a)
                $template.find(".preview-option_b").text(option_b)
                $template.find(".preview-option_c").text(option_c)
                $template.find(".preview-option_d").text(option_d)

                $template.find(".que-preview-edit").hide(666)
                $template.find(".que-preview").show(666)
                $template.find(".que-edit").css("opacity",1)
                var edit = $("#box-question").data("edit")
                edit = edit - 1
                $("#box-question").data("edit", edit)
                if (edit == 0) $("#que-add").show(666)
            }

            $(".que-save").on("click",function(){
                $(this).css("opacity",0)
                var $template = $(this).closest(".box-template")
                var formData = new FormData($template.find("form")[0])
                $("#box-loading").show()
                $.ajax({
                    type: "post",
                    crossDomain: true,
                    url: save_question,
                    data: formData,
                    cache: false,
                    processData: false,
                    contentType: false,
                    success: function(data){
                        $("#box-loading").hide()
                        //如果上传了图片
                        var title_image = data.data.title_image
                        var src_image = data.data.src_image
                        var src_sound = data.data.src_sound
                        console.log(title_image,src_image)
                        if(title_image){
                            $template.find(".preview-title_image").attr("src", title_image)
                            $template.find(".preview-title_image").show()

                            $template.find(".img-title_image").attr("src", title_image)
                            $template.find(".que-title_image").val(title_image)
                        }
                        if(src_image){
                            $template.find(".preview-src_image").attr("src", src_image)
                            $template.find(".box-preview-article").hide()
                            $template.find(".preview-src_image").show()
                        }
                        if(src_sound){
                            $template.find(".preview-src_sound").attr("src", src_sound)
                            $template.find(".preview-src_sound").show()
                        }
                        showQuePreview($template)
                    },
                    complete: function(data){
                        console.log(data)
                        $("#box-loading").hide()
                    }
                })
            })

            $(".right_option").on("click",function(){
                var $box = $(this).closest(".que-preview-edit")
                var option = $(this).data("option")
                console.log(option)
                $box.find(".right_option").each(function(){
                    $(this).removeClass("active")
                })
                $(this).addClass("active")
                $box.find(".que-right_option").val(option)
            })
            
            $("#que-add").on("click",function(){
                var que_no = parseInt($(this).data("que_no"))
                var que_type = $(this).data("type")
                que_no += 1
                console.log(que_type, que_no)
                var $box = $("#box-question")
                var $template = $("#template-que").clone(true)

                if (que_type > 10 && que_type <= 20 && que_no == 1){
                    $template.find(".btn-type-read").show()
                    $template.find(".label-article").trigger("click")
                    $template.find(".box-preview-article").show()
                }else if (que_type > 20 && que_no == 1){
                    $template.find(".box-type-sound").show()
                }

                $(this).data("que_no", que_no)
                var edit = $("#box-question").data("edit")
                edit = edit + 1
                $("#box-question").data("edit", edit)
                $template.find(".preview-question_no").text(que_no)
                $template.find(".label-question_no").text(que_no)
                $template.find(".que-question_no").val(que_no)
                var paper_id = $("#paper-title").data("paper_id")
                $template.find(".que-paper_id").val(paper_id)
                $template.find(".que-type").val(que_type)

                $(this).hide()
                $template.find(".que-preview").hide()
                $template.find(".que-preview-edit").show()
                
                $template.removeAttr("id")
                $template.insertBefore($(this))
                $template.show(233)
            })

            var savePaper = function(t_paper){
                console.log(t_paper)
                $("#paper-bar").css("width", "0%")
                $("#box-loading").show()
                $.ajax({
                    type: "post",
                    crossDomain: true,
                    url: save_paper,
                    data: t_paper,
                    success: function(data){
                        console.log(data)
                        $("#paper-bar").css("width", "100%")
                        $("#paper-menu").show(666)
                    },
                    complete: function(data){
                        $("#box-loading").hide()
                    }
                })
            }

            $(".paper-save").on("click",function(){
                var $title = $("#paper-title")
                var title = $title.val().trim()
                var description = $("#paper-description").val().trim()
                var attention = $("#paper-attention").val()
                var level = $("#paper-level").val()
                var difficulty = $("#paper-difficulty").find('label[class="btn btn-default active"] > input').val()

                if (title == ""){
                    $title.focus()
                    return
                }
                var paper_id = $title.data("paper_id")
                var uploader = __openid
                var t_paper = {paper_id,title,description,attention,level,difficulty,uploader}
                savePaper(t_paper)
            })

            $(".paper-delete").on("click",function(){
                $("#paper-bar").css("width", "0%")
                $("#paper-menu").hide()
            })

            $(".btn-type-read > label").on("click",function(){
                var $template = $(this).closest(".box-template")
                var box_class = "." + $(this).data("box")
                console.log(box_class)
                $template.find(".box-type-article").hide()
                $template.find(".box-type-image").hide()
                $template.find(box_class).show()
            })

            $(".que-big-type > label").on("click",function(){
                //隐藏所有
                $(".s-que-type").hide()
                $("#box-question").hide()
                $(".box-template").hide()

                var id_type = "#"+$(this).data("type")
                $(id_type).show()
                $(id_type).find("option").each(function(){
                    $(this).removeAttr("selected")
                })
                var $option = $(id_type).find("option:eq(0)")
                $option.attr("selected", true)
                $(id_type).find("select").trigger("change")
                /*
                //试卷预览
                if (id_type == "0"){
                    $("#que-add").hide()
                    for (let i of [1,2,3,4]){
                        var que_type_class = ".type_" + i
                        $(que_type_class).each(function(){
                            $(this).show(233)
                        })
                    }
                }
                */
            })

            $(".s-que-type > select").on("change",function(){
                var que_type = parseInt($(this).val())
                console.log(que_type)
                //把 试题类型/试题编号 放在 '+' 按钮上
                var que_no = 0
                $("#que-add").data("type", que_type)

                //隐藏所有
                $(".box-template").hide()
                if (que_type == 0) return
                //显示对应类型的试题
                $("#que-add").show()
                $("#box-question").show()
                $("#box-que-bar").show()
                var que_type_class = ".type_" + que_type
                $(que_type_class).each(function(){
                    que_no += 1
                    $(this).show(233)
                })
                $("#que-add").data("que_no", que_no)
            })

            $("#btn-play").on("click",function(){
                var src_audio = $("#src-audio").text()
                console.log(src_audio)
                loadSound(src_audio, 1)
            })

            //备战完成时
            $("#modal-to").on('hidden.bs.modal', function (e) {
                $("#btn-prepare").trigger("click")
            })

            //试卷隐藏时
            $("#modal-paper").on('hidden.bs.modal', function (e) {
                console.log("hidden...")
                $("#box-question").hide()
                $("#box-que-bar").hide()
                $(".s-que-type").hide()
                $(".box-template").each(function(){
                    if($(this).attr("id") == undefined){
                        $(this).remove()
                    }
                })
                $("#btn-paper").trigger("click")
            })
        })


    </script>

</header>

<body>

<div id="box-loading" class="box-loading" style="display: none">
    <img src="https://systems-1256378396.cos.ap-guangzhou.myqcloud.com/up_loading.png" alt="...">
</div>

    <div id="modal-to" class="modal fade bs-example-modal-lg" aria-hidden="true" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="to_list">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="m-title">file_id</h4>
                        </div>

                        <div class="modal-body">
                            <form id="my-form" class="form-horizontal" enctype="multipart/form-data">
                                <input id="s-shadow" name="shadow" type="hidden">
                                <input id="s-file_id" name="file_id" type="hidden">
                                <div class="box-content">
                                    <input id="file_audio" name="file_audio" class="up-image pointer" type="file">
                                    <img class="box-image" src="">
                                    <div class="box-text">
                                        <p id="src-audio" class="hidden"></p>
                                        <strong><p id="p-title" class="text-primary"></p></strong>
                                        <p id="p-serifu" class="text-primary"></p>
                                        <p id="p-roma" class="text-primary"></p>
                                    </div>
                                </div>
                                    <div id="box-shadow" class="box-shadow">
                                        <div id="btn-play" class="box-image pointer"></div>
                                    </div>
                                    <hr>
                                <div class="form-group">
                                    <label class="text-primary col-sm-2 control-label">式神名字:</label>
                                    <div class="col-sm-9">
                                        <input id="s-c_name" name="c_name" type="text" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="text-primary col-sm-2 control-label">标题:</label>
                                    <div class="col-sm-9">
                                        <input id="s-title" name="title" type="text" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="text-primary col-sm-2 control-label">台词:</label>
                                    <div class="col-sm-9">
                                    <input id="s-serifu" name="serifu" type="text" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="text-primary col-sm-2 control-label">罗马音:</label>
                                    <div class="col-sm-9">
                                        <input id="s-roma" name="roma" type="text" class="form-control">
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button id="btn-save" type="button" class="btn btn-primary">保存</button>
                    </div>
            </div>
        </div>
    </div>
<!-- modal end -->

<div id="modal-paper" class="modal fade bs-example-modal-lg" aria-hidden="true" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="to_list">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">编辑试题</h4>
                </div>

                    <div class="modal-body">
                        <div class="box-question-title">
                        <form class="form-horizontal" enctype="multipart/form-data">
                            <strong class="pull-right menu-que pointer">
                                <span class="paper-save glyphicon glyphicon-floppy-save" aria-hidden="true" style="display: none"></span>
                            </strong>
                                <div class="form-group">
                                    <label class="col-sm-2 text-primary control-label">标题:</label>
                                    <div class="col-sm-8">
                                    <input id="paper-title" name="title" type="text" class="form-control">
                                    </div>
                                </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 text-primary control-label">备注:</label>
                                        <div class="col-sm-4">
                                            <input id="paper-description" name="description" type="text" class="form-control">
                                        </div>
                                        <select id="paper-level" class="col-sm-3 form-control paper-level">
                                            <option value="N4">--等级难度--</option>
                                            <option value="N2">N2</option>
                                            <option value="N3">N3</option>
                                            <option id="level-default" value="N4">N4</option>
                                            <option value="N5">N5</option>
                                        </select>
                                        <div id="paper-difficulty" class="btn-group" data-toggle="buttons">
                                            <label id="paper-easy" class="btn btn-default">
                                                <input type="radio" value="easy" name="options" autocomplete="off">简单
                                            </label>
                                            <label id="paper-normal" class="btn btn-default active">
                                                <input type="radio" value="normal" name="options" autocomplete="off">正常
                                            </label>
                                            <label id="paper-hard" class="btn btn-default">
                                                <input type="radio" value="hard" name="options" autocomplete="off">困难
                                            </label>
                                        </div>
                                    </div>
                                <div class="form-group">
                                    <label class="col-sm-2 text-primary control-label">试卷说明:</label>
                                    <div class="col-sm-9">
                                        <textarea id="paper-attention" name="attention" class="que-an_explain form-control" rows="3"></textarea>
                                    </div>
                                </div>
                        </form>
                    </div>

<div class="progress" style="height: 1px;">
    <div id="paper-bar" class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <span class="sr-only">100%</span>
    </div>
</div>
<div id="paper-menu" class="text-center" style="display: none;margin-bottom: 20px;">
    
    <div class="que-big-type btn-group" data-toggle="buttons">
        <label data-type="0" class="btn btn-default">
            <input type="radio" name="options" autocomplete="off">试卷预览
        </label>
        <label data-type="type_select" class="btn btn-default">
            <input type="radio" name="options" autocomplete="off">选择题
            <span class="badge" style="background-color: #999"></span>
        </label>
        <label data-type="type_read" class="btn btn-default">
            <input type="radio" name="options" autocomplete="off">阅读题
            <span class="badge" style="background-color: #999"></span>
        </label>
        <label data-type="type_listen" class="btn btn-default">
            <input type="radio" name="options" autocomplete="off">听解题
            <span class="badge" style="background-color: #999"></span>
        </label>
    </div>

    <div id="type_select" class="s-que-type" style="margin: 10px auto 10px;width:400px;display: none">
        <select class="text-center form-control">
            <option value="1">选择题1--根据汉字选假名 / 根据假名选汉字</option>
            <option value="2">选择题2--选择合适的单词(句意)</option>
            <option value="3">选择题3--选择意思相近的句子</option>
            <option value="4">选择题4--选择合适的单词(文法)</option>
            <option value="5">选择题5--适当的顺序连接成句子(选择★位置的选项)</option>
        </select>
    </div>

    <div id="type_read" class="s-que-type" style="margin: 10px auto 10px;width:400px;display: none">
        <select class="text-center form-control">
            <option value="11">阅读题--第一篇</option>
            <option value="12">阅读题--第二篇</option>
            <option value="13">阅读题--第三篇</option>
            <option value="14">阅读题--第四篇</option>
            <option value="15">阅读题--第五篇</option>
        </select>
    </div>

    <div id="type_listen" class="s-que-type" style="margin: 10px auto 10px;width:400px;display: none">
        <select class="text-center form-control">
            <option value="21">听解题1--语音/图片/选项</option>
            <option value="22">听解题2--语音/图片/选项</option>
            <option value="23">听解题3--语音/图片/选项</option>
            <option value="24">听解题4--语音/选项</option>
        </select>
    </div>

</div>
<div id="box-que-bar" class="progress" style="display: none;height: 1px;">
    <div id="que-bar" class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <span class="sr-only">100%</span>
    </div>
</div>
            <div id="box-question" class="box-question" data-edit="0" style="display: none">

                <div id="template-que" class="box-template" style="display: none">
                    <div class="que-preview">
                        <strong class="pull-right menu-que pointer">
                            <span class="que-edit glyphicon glyphicon-edit" aria-hidden="true" style="display: none"></span>
                        </strong>
                        <div class="box-preview-article form-groupe" style="display: none">
                            <label class="text-primary control-label">阅读材料:</label>
                            <textarea class="preview-article form-control" rows="6" readonly></textarea>
                        </div>
                        <img class="que-src-image preview-src_image" src="" style="display: none">
                        <audio class="preview-src_sound" src="" controls="controls" style="display: none">
                        Your browser does not support the audio element.
                        </audio>
                        <h4><strong class="preview-question_no text-info mg-right"></strong><span class="preview-title">世界杯的作用是?</span></h4>
                        <img class="que-image preview-title_image" src="" style="display: none">
                        <p><strong class="text-primary mg-right">A.</strong><span class="preview-option_a">许愿</span></p>
                        <p><strong class="text-primary mg-right">B.</strong><span class="preview-option_b">喝酒</span></p>
                        <p><strong class="text-primary mg-right">C.</strong><span class="preview-option_c">摆饰</span></p>
                        <p><strong class="text-primary mg-right">D.</strong><span class="preview-option_d"></span></p>
                    </div>
                    <div class="que-preview-edit" style="display: none">
                        <strong class="pull-right menu-que pointer">
                            <span class="que-save glyphicon glyphicon-floppy-save" aria-hidden="true" style="display: none"></span>
                        </strong>
                        <div class="btn-group" data-toggle="buttons">
                            <label class="src-que btn btn-sm btn-default title_image" data-box="box-title-image">
                                <input type="checkbox" autocomplete="off"><span>添加图片</span>
                            </label>
                        </div>

                        <div class="btn-type-read btn-group" data-toggle="buttons" style="display: none">
                            <label class="btn btn-sm btn-default label-article" data-box="box-type-article">
                                <input type="radio" autocomplete="off"><span>阅读材料(文字)</span>
                            </label>
                            <label class="btn btn-sm btn-default label-image" data-box="box-type-image">
                                <input type="radio" autocomplete="off"><span>阅读材料(图片)</span>
                            </label>
                        </div>
                        <hr>
                        <form class="form-horizontal" enctype="multipart/form-data">
                            <input class="que-type" name="type" type="hidden" value="1">
                            <input class="que-paper_id" name="paper_id" type="hidden" value="0">
                            <input class="que-question_no" name="question_no" type="hidden" value="0">
                            <input class="que-uploader" name="uploader" type="hidden" value="someone">
                            <input class="que-title_image" name="title_image" type="hidden" value="">
                            <input class="que-src_image" name="src_image" type="hidden" value="">

                            <div class="box-type-article form-groupe" style="display: none">
                                <label class="text-primary control-label">阅读材料:</label>
                                <textarea name="article" class="que-article form-control" rows="8"></textarea>
                            </div>
                            <div class="box-type-image form-group" style="display: none">
                                <label class="text-primary col-sm-2 control-label">图片材料:</label>
                                <div class="col-sm-8">
                                    <div class="box-content">
                                        <input name="file_src_image" class="file_src_image up-que-src-image pointer" type="file">
                                        <img class="que-src-image" src="">
                                    </div>
                                </div>
                            </div>
                            <div class="box-type-sound form-group" style="display: none">
                                <label class="text-primary control-label mg-right">语音材料:</label>
                                <div style="display: inline-flex">
                                    <input name="file_sound" class="up-que-sound pointer" type="file">
                                    <input type="text" class="form-control" placeholder="点击选择音频" style="width: 450px" readonly>
                                    <button type="button" class="que-sound-listen btn btn-default" style="display: none">试听</button>
                                </div>
                            </div>

                            <hr>
                            <div class="form-group">
                                <label class="text-primary col-sm-1 control-label">
                                    <strong class="label-question_no text-info mg-right">1</strong>
                                </label>
                                <div class="col-sm-9">
                                    <textarea name="title" class="que-title form-control" rows="2" placeholder="题目"></textarea>
                                </div>
                            </div>
                            <div class="box-title-image form-group" style="display: none">
                                <label class="text-primary col-sm-1 control-label">图片:</label>
                                <div class="col-sm-9">
                                    <div class="box-content">
                                        <input name="file_title_image" class="file_title_image up-que-image pointer" type="file">
                                        <img class="que-image img-title_image" src="">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="text-primary col-sm-1 control-label">
                                    <strong class="text-info mg-right">A.</strong>
                                </label>
                                <div class="col-sm-6">
                                    <input name="option_a" placeholder="选项A" type="text" class="que-option_a form-control">
                                </div>
                                <button type="button" data-option="A" class="right_option right_option_a btn btn-default col-sm-2">正解</button>
                            </div>
                            <div class="form-group">
                                <label class="text-primary col-sm-1 control-label">
                                    <strong class="text-info mg-right">B.</strong>
                                </label>
                                <div class="col-sm-6">
                                    <input name="option_b" placeholder="选项B" type="text" class="que-option_b form-control">
                                </div>
                                <button type="button" data-option="B" class="right_option right_option_b btn btn-default col-sm-2">正解</button>
                            </div>
                            <div class="form-group">
                                <label class="text-primary col-sm-1 control-label">
                                    <strong class="text-info mg-right">C.</strong>
                                </label>
                                <div class="col-sm-6">
                                    <input name="option_c" placeholder="选项C" type="text" class="que-option_c form-control">
                                </div>
                                <button type="button" data-option="C" class="right_option right_option_c btn btn-default col-sm-2">正解</button>
                            </div>
                            <div class="form-group">
                                <label class="text-primary col-sm-1 control-label">
                                    <strong class="text-info mg-right">D.</strong>
                                </label>
                                <div class="col-sm-6">
                                    <input name="option_d" placeholder="选项D" type="text" class="que-option_d form-control">
                                </div>
                                <button type="button" data-option="D" class="right_option right_option_d btn btn-default col-sm-2">正解</button>
                            </div>
                            <hr>
                            <div class="form-group">
                                <label class="text-primary col-sm-2 control-label">正解:</label>
                                <div class="col-sm-9">
                                    <input name="right_option" type="text" class="que-right_option form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="text-primary col-sm-2 control-label">解析:</label>
                                <div class="col-sm-9">
                                    <textarea name="an_explain" class="que-an_explain form-control" rows="3"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div id="que-add" class="box-que-add pointer prepare text-primary">
                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                </div>
            </div><!-- box-question end -->
          
        </div><!-- modal-body end -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
        </div>
    </div>
</div>
<!-- modal end -->

    <hr>
    <div class="text-center">

        <div id="top-login" style="width: 20%; margin: 0 auto">
            <input id="auth-name" placeholder="用户名 / 成员编号" type="text" class="form-control top-auth">
            <input id="auth-code" placeholder="密码" type="password" class="form-control top-auth">
            <div class="btn-group" role="group" aria-label="...">
                <button id="auth-btn" type="button" class="btn btn-info top-auth">登录</button>
            </div>
        </div>
                
        <div id="top-menu" class="btn-group" data-toggle="buttons" style="display: none">
            <label class="btn btn-default active">
                <input type="radio" name="options" autocomplete="off" checked>战斗式神
            </label>
            <label id='btn-prepare' class="btn btn-default">
                <input type="radio" name="options" autocomplete="off">备战式神
            </label>
            <label id="btn-paper" class="btn btn-default">
                <input type="radio" name="options" autocomplete="off">试卷
            </label>
        </div>
    </div>
    <hr>
    <div class="">
        <table id="t_audio" class="table table-bordered table-striped table-hover" style="display: none">
            <thead>
                <tr>
                    <th>#</th>
                    <th>level</th>
                    <th>file_id</th>
                    <th>c_name</th>
                    <th>ski</th>
                    <th>ver</th>
                    <th>s_name</th>
                    <th>cate</th>
                    <th>c_date</th>
                    <th>status</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <table id="t_content" class="table table-bordered table-striped table-hover" style="display: none">
            <thead>
                <tr>
                    <th>#</th>
                    <th>level</th>
                    <th>file_id</th>
                    <th>s_name</th>
                    <th>ski</th>
                    <th>ver</th>
                    <th>size</th>
                    <th>u_date</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <table id="t_paper" class="table table-bordered" style="display: none">
            <thead>
                <tr>
                    <th>#</th>
                    <th>标题</th>
                    <th>备注</th>
                    <th>题目数</th>
                    <th>日语等级</th>
                    <th>难度</th>
                    <th>创建者</th>
                    <th>创建时间</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
            <tfoot>
                <tr id="paper-add" ><td colspan="8" class="text-center prepare pointer text-primary">
                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                </td></tr>
            </tfoot>
        </table>
    </div>

</body>

</html>